name: Build Armbian X96Q H313 (Bullseye Minimal) & Release

on:
  workflow_dispatch:

permissions:
  contents: write   # 允许创建 release

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 480

    steps:
    - name: Checkout helper repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget curl build-essential ccache bc bison flex \
          python3 python3-pip python-is-python3 libncurses5-dev libssl-dev device-tree-compiler \
          libtool unzip

    - name: Clone official Armbian build
      run: git clone --depth=1 https://github.com/armbian/build build

    - name: Copy helper files into build tree
      run: |
        mkdir -p build/config/boards build/patches/dts build/userpatches
        cp -r config/boards/*       build/config/boards/ || true
        cp -r patch/kernel/sunxi-current/* build/patches/dts/ || true
        cp -r userpatches/*         build/userpatches/     || true
        chmod +x build/userpatches/customize-image.sh || true

    - name: Build Armbian (use pre-built rootfs to bypass binfmt)
      working-directory: build
      run: |
        export DEBIAN_FRONTEND=noninteractive
        ./compile.sh \
          BOARD=x96q-h313 BRANCH=current RELEASE=bullseye \
          BUILD_DESKTOP=no BUILD_MINIMAL=yes \
          KERNEL_ONLY=no KERNEL_CONFIGURE=no \
          SKIP_BOOTSPLASH=yes SHARE_LOG=yes \
          USE_PREBUILT_ROOTFS=yes \
          ROOTFS_TYPE=bullseye-current

    - name: Pack images
      run: |
        cd build/output/images
        tar -czf ../../../armbian-x96q-h313-bullseye-minimal.tar.gz *.img
      shell: bash

    - name: Generate tag
      id: tag
      run: |
        TAG="v$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Create Release & Upload asset
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "Armbian X96Q H313 Bullseye Minimal ${{ steps.tag.outputs.tag }}"
        body: |
          自动构建的 Armbian 最小化镜像  
          - 设备：X96Q H313  
          - 系统：Debian Bullseye  
          - 内核：当前 sunxi 主线  
          - 构建时间：${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
        files: armbian-x96q-h313-bullseye-minimal.tar.gz
        draft: false
        prerelease: false
